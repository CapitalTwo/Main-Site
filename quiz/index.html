<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <title>Capital Two - Quiz</title>

    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="../css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <style>
        body {
            background-image: url('./bg_quiz.png');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center bottom;
            background-size: cover;
        }
    </style>
</head>

<body>
    <nav class="Maroon" id="navbar" role="navigation" style='background-color: rgba(0,0,0,0);'>
        <div class="nav-wrapper container center"><a id="logo-container" href="#" class="brand-logo center">Capital Two - Quiz</a>
        </div>
    </nav>

    <div id="content">

    </div>





    <!--  Scripts-->

    <script src="../js/materialize.js"></script>
    <script>
        M.AutoInit();

        var request;
        $(document).ready(function() {
            request = {
                QueryString: function(val) {
                    var uri = window.location.search;
                    var re = new RegExp("" + val + "=([^&?]*)", "ig");
                    return ((uri.match(re)) ? (uri.match(re)[0].substr(val.length + 1)) : null);
                }
            }
            var _srcHeight = parseInt(window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight);
            var result = $("#navbar").height();
            if (request.QueryString("code") != null && request.QueryString("code") != "") {
                document.getElementById("content").innerHTML = '<div class="container row" style="margin-top: ' + (_srcHeight * 0.2 - result) + 'px;"><div class="col s12"><div class="card white z-depth-3"><div class="card-content black-text"><span class="card-title">Quiz Code</span><p>We receive a requiest of quiz number: ' + request.QueryString("code") + '</p><p id="result"></p></div>  <div id="loading"><div class="progress" >      <div class="indeterminate"></div>  </div></div><div class="card-action"><div id="holder"></div></div></div></div></div></div>';
                generateForm();
            } else {
                document.getElementById("content").innerHTML = '<div class="container row" style="margin-top: ' + (_srcHeight * 0.4 - result) + 'px;"><div class="col s3"></div><div class="col s6"><div class="card white z-depth-3"><div class="card-content black-text"><span class="card-title">Look for a quiz?</span><p>Type in the quiz code below and click process to go to related quiz page</p><div class="input-field"><input id="quizcode" type="text" class="validate"><label for="quizcode">Quiz Code</label></div> <div class="row"><div class="col s12 m8"></div> <button class="col s12 m4 btn waves-effect waves-light" type="submit" name="action" onclick="handleExplorer()">Proceed<i class="material-icons right">send</i></button></div></div></div></div></div></div></div>';
            }
        });

        function handleExplorer() {
            //window.location.href="https://capitaltwo.ga/quiz/index.html?code="+document.getElementById('quizcode').value;
            self.location = "https://capitaltwo.ga/quiz/index.html?code=" + document.getElementById('quizcode').value;
        }

        var br = document.createElement("br");
        var nQuiz = 0;

        function generateForm() {

            fetch('https://cool-forest-d491.1442334619.workers.dev', {
                    method: "POST",
                    body: JSON.stringify({
                        "Task": "GetPreDefinedQuizzes",
                        "quizcode": request.QueryString("code")
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Create a form synamically 
                    var form = document.createElement("form");
                    form.setAttribute("onsubmit", "return checkForm()");
                    form.setAttribute("action", "#");
                    nQuiz = data.length;

                    for (let k = 0; k < data.length; k++) {
                        console.log(k);
                        let Text = document.createElement("p");
                        Text.innerText = (k + 1) + ". " + data[k].QuestionText;
                        form.appendChild(Text);

                        for (let options of Object.keys(data[k].Choices)) {
                            // Create an input element for Full Name 
                            let FN = document.createElement("div");
                            FN.innerHTML = '<p><label><input class="with-gap" id="group' + k + '' + options + '" name="group' + data[k].QNumber + '" type="radio" value="' + options + '"/><span>' + data[k].Choices[options] + '</span></label></p>';

                            form.appendChild(FN);
                        }


                        let HiddenText = document.createElement("input");
                        HiddenText.setAttribute("type", "hidden");
                        HiddenText.setAttribute("id", "number" + k);
                        HiddenText.setAttribute("value", data[k].QNumber);
                        form.appendChild(HiddenText);
                        HiddenText = document.createElement("div");
                        HiddenText.setAttribute("id", "Explanation" + data[k].QNumber);
                        form.appendChild(HiddenText);

                        // Inserting a line break 
                        form.appendChild(br.cloneNode());
                    }

                    // create a submit button 



                    var s = document.createElement("div");
                    s.setAttribute("class", "row");
                    s.innerHTML = '<div class="col s12 m8"></div> <button class="col s12 m4 btn waves-effect waves-light" type="submit" name="action">Proceed<i class="material-icons right">send</i></button>';

                    // Append the submit button to the form 
                    form.appendChild(s);
                    document.getElementById("holder").innerHTML = '';
                    document.getElementById("loading").innerHTML = '';
                    document.getElementById("holder").appendChild(form);
                })
                .catch(error => {
                    console.error(error)
                    document.getElementById("loading").innerHTML = '';
                    document.getElementById("holder").innerHTML = "<font style='color: red'>Invalid code</font>"
                })
        }

        function checkForm() {
            console.log(document.getElementById('number1').value);

            let toSend = [];
            toSend.push({
                "Task": "Validation",
                "quizcode": request.QueryString("code")
            })
            for (let i = 0; i < nQuiz; i++) {
                let qnumber = document.getElementById('number' + i).value;
                let ele = document.getElementsByName('group' + qnumber);
                let choice = "";
                for (let i = 0; i < ele.length; i++) {
                    if (ele[i].checked) {
                        choice = ele[i].value;
                        console.log(ele[i].value + ":" + ele[i].innerHTML);
                    }
                }
                if (choice.localeCompare("") == 0) {
                    document.getElementById("result").innerText = "Please fill all answer";
                    return false;
                }
                toSend.push({
                    "QNumber": qnumber,
                    "Selection": choice
                })
            }
            console.log(toSend);
            generateContent(toSend);

            return false;
        }

        async function generateContent(send) {
            document.getElementById("loading").innerHTML = '<div class="progress" >      <div class="indeterminate"></div>  </div>';

            let data = await (await fetch('https://cool-forest-d491.1442334619.workers.dev', {
                method: "POST",
                body: JSON.stringify(send)
            }).json());

            console.log(data);

            document.getElementById("result").innerText = data[0].pass;
            for (let i = 1; i < data.length; i++) {
                if (data[i].Correct) {
                    let ele = document.getElementsByName('group' + data[i].QNumber);
                    for (let j = 0; j < ele.length; j++) {
                        if (ele[j].checked) {
                            ele[j].style.backgroundColor = 'lightblue';
                            ele[j].style.borderColor = 'blue';
                        }
                    }
                    document.getElementById("Explanation" + data[i].QNumber) = data[i].Explanation;
                } else {
                    let ele = document.getElementsByName('group' + data[i].QNumber);
                    for (let j = 0; j < ele.length; j++) {
                        if (ele[j].checked) {
                            ele[j].style.backgroundColor = '#ffcccb';
                            ele[j].style.borderColor = 'red';
                        }
                    }
                    document.getElementById("Explanation" + data[i].QNumber) = data[i].Explanation;
                }
            }
            document.getElementById("loading").innerHTML = '';

        }
    </script>

</body>

</html>